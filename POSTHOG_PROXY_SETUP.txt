===========================================
POSTHOG REVERSE PROXY SETUP GUIDE
===========================================

This guide will help you setup a reverse proxy for PostHog on e.evenleads.com using aaPanel.

WHY USE A REVERSE PROXY?
-------------------------
1. Avoid ad blockers blocking PostHog tracking
2. First-party data collection (better for privacy compliance)
3. Improved tracking reliability
4. Better cookie handling

SETUP STEPS IN AAPANEL:
========================

Step 1: Create a new website in aaPanel
-----------------------------------------
1. Log into your aaPanel
2. Go to "Website" → "Add site"
3. Domain name: e.evenleads.com
4. Root directory: /www/wwwroot/e.evenleads.com (or any location, won't be used)
5. PHP version: Pure static (since this is just a proxy)
6. Click "Submit"

Step 2: Setup SSL Certificate
-------------------------------
1. After creating the site, click on the domain name "e.evenleads.com"
2. Go to the "SSL" tab
3. Select "Let's Encrypt"
4. Enter your email and click "Apply"
5. Wait for the SSL certificate to be issued

Step 3: Configure Nginx Reverse Proxy
---------------------------------------
1. In aaPanel, go to "Website" → Click on "e.evenleads.com"
2. Go to "Config Files" or "Nginx Configuration"
3. Replace the entire configuration with the content from the file:
   e.evenleads.com.nginx.conf (included in your project folder)

   OR manually add these location blocks inside the server {} block:

   # Proxy PostHog static assets (JS library)
   location /static/ {
       proxy_pass https://eu-assets.i.posthog.com/static/;
       proxy_set_header Host eu-assets.i.posthog.com;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_ssl_server_name on;

       # Cache static assets
       proxy_cache_valid 200 30d;
       proxy_cache_valid 404 1m;
       add_header Cache-Control "public, max-age=2592000" always;

       # CORS headers
       add_header Access-Control-Allow-Origin * always;
   }

   # Proxy PostHog API endpoints
   location ~ ^/(batch|capture|decide|e|engage|track|identify|alias|page|screen|group|s)/?$ {
       proxy_pass https://eu.i.posthog.com$request_uri;
       proxy_set_header Host eu.i.posthog.com;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_ssl_server_name on;

       # CORS headers
       add_header Access-Control-Allow-Origin * always;
       add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
       add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

       if ($request_method = OPTIONS) {
           return 204;
       }
   }

   # Catch-all for other PostHog endpoints
   location / {
       proxy_pass https://eu.i.posthog.com;
       proxy_set_header Host eu.i.posthog.com;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_ssl_server_name on;

       add_header Access-Control-Allow-Origin * always;
       add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
       add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

       if ($request_method = OPTIONS) {
           return 204;
       }
   }

4. Click "Save"
5. Test the configuration: In aaPanel, there's usually a "Test Configuration" button
6. If test passes, reload Nginx

Step 4: Test the Proxy
------------------------
1. Open a browser and go to: https://e.evenleads.com/static/array.js
2. You should see the PostHog JavaScript library loaded
3. Test the API endpoint: https://e.evenleads.com/decide
   (It should return a response or require a POST request)

Step 5: Clear Application Caches (ALREADY DONE)
-------------------------------------------------
✓ PostHog plugin updated to use proxy
✓ Database settings configured with proxy URL
✓ Proxy enabled in settings

Step 6: Verify PostHog is Working
-----------------------------------
1. Open your website (evenleads.com) in a browser
2. Open Developer Tools (F12) → Console tab
3. Accept cookie consent for analytics if prompted
4. You should see PostHog initializing
5. Go to Network tab → Filter by "e.evenleads.com"
6. You should see requests going to e.evenleads.com instead of eu.i.posthog.com

TROUBLESHOOTING:
================

Issue: SSL Certificate Error
Solution: Make sure Let's Encrypt certificate is properly installed for e.evenleads.com

Issue: 502 Bad Gateway
Solution:
- Check if proxy_ssl_server_name is set to "on"
- Verify your server can reach eu.i.posthog.com

Issue: CORS errors in console
Solution: Make sure all the add_header directives are present in the Nginx config

Issue: Static assets not loading
Solution: Clear browser cache and check if /static/ path is working correctly

Issue: Events not being captured
Solution:
- Clear Laravel cache: php artisan cache:clear
- Check browser console for errors
- Verify cookie consent is accepted

CHECKING LOGS:
==============
- Access logs: /www/wwwlogs/e.evenleads.com.log
- Error logs: /www/wwwlogs/e.evenleads.com.error.log

DISABLING THE PROXY:
====================
If you need to disable the proxy and go back to direct PostHog:

1. SSH to server:
   cd /www/wwwroot/evenleads.com
   php artisan tinker --execute="
   \Wave\Plugins\PostHog\Models\PostHogSetting::where('key', 'posthog_use_proxy')->update(['value' => '0']);
   echo 'Proxy disabled';
   "

2. Clear cache:
   php artisan cache:clear && php artisan optimize

CURRENT CONFIGURATION:
======================
✓ PostHog Plugin: Enabled
✓ Proxy Mode: Enabled
✓ Proxy URL: https://e.evenleads.com
✓ PostHog API Key: phc_tjeTIG2kbl9LoHauXjInmym6c2CrKqtwg9cNapRxPLz
✓ PostHog Region: EU (eu.i.posthog.com)

FILES CREATED:
==============
1. e.evenleads.com.nginx.conf - Full Nginx configuration
2. posthog-proxy-nginx.conf - Just the proxy location blocks
3. This setup guide

Next step: Follow the aaPanel steps above to complete the setup!
